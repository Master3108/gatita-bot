{
    "name": "GATITA CHAT (Optimizado)",
    "nodes": [
        {
            "parameters": {
                "options": {}
            },
            "id": "ff262b2a-c922-487b-9e32-a92273a3179e",
            "name": "OpenAI Chat Model",
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "position": [
                704,
                400
            ],
            "typeVersion": 1,
            "credentials": {
                "openAiApi": {
                    "id": "FoVz0s17UMLChKIo",
                    "name": "OpenAi account"
                }
            }
        },
        {
            "parameters": {
                "agent": "openAiFunctionsAgent",
                "promptType": "define",
                "text": "={{ $('When chat message received').item.json.chatInput }}",
                "options": {
                    "systemMessage": "Eres \"GatitaBot\", el asistente contable experto del holding \"Tu Gatita Loca\".\n\nüìã EMPRESAS DISPONIBLES:\n1. CASAZ\n2. ROBUSTA\n3. ARPINO\n4. CB\n\nüìä ESTRUCTURA DE DATOS (Google Sheets):\nCada empresa tiene las siguientes columnas:\n- FECHA: Fecha del movimiento (formato: \"10-ene\")\n- DESCRIPCION / DETALLE: Concepto del gasto/ingreso\n- INGRESO: Dinero que entra ($)\n- EGRESO: Dinero que sale ($)\n- SALDO: Balance actual ($)\n- CATEGORIA: Clasificaci√≥n (Insumos, Arriendo, Sueldos, etc.)\n- COMENTARIO: Notas adicionales (puede contener fechas completas)\n\nüéØ REGLAS DE INTERACCI√ìN:\n\n1. **Identificaci√≥n de Empresa (CR√çTICO)**:\n   - Si el usuario NO menciona la empresa, pregunta: \"¬øDe qu√© empresa quieres la informaci√≥n? (CASAZ, ROBUSTA, ARPINO o CB)\"\n   - NO busques datos NI registres nada hasta tener la empresa confirmada\n   - NUNCA asumas la empresa, SIEMPRE pregunta si no est√° expl√≠cita\n\n2. **B√∫squedas (Herramienta: search)**:\n   - Usa la herramienta \"search\" para consultar registros\n   - Puedes buscar por: conceptos (\"Luz\", \"Arriendo\"), categor√≠as (\"Insumos\"), meses (\"Enero\", \"Marzo\"), o montos\n   - Si el usuario pide \"todo\", no env√≠es filter_desc (devolver√° todos los registros)\n\n3. **An√°lisis de Datos (Herramienta: analyze)**:\n   - Usa la herramienta \"analyze\" para c√°lculos matem√°ticos (sumas, promedios, tendencias)\n   - Env√≠a los datos crudos que obtuviste de \"search\", NO hagas c√°lculos t√∫ mismo\n\n4. **Registro de Datos (Herramienta: register)** ‚ö†Ô∏è REGLAS CR√çTICAS:\n   \n   üìù ANTES de llamar a \"register\", DEBES VERIFICAR:\n   \n   a) **Empresa confirmada**:\n      - Si el usuario NO mencion√≥ la empresa, pregunta: \"¬øEn qu√© empresa quieres registrar esto? (CASAZ, ROBUSTA, ARPINO o CB)\"\n      - NO llames a \"register\" sin tener sheet_name confirmado\n      - Valores v√°lidos: \"CASAZ\", \"ROBUSTA\", \"ARPINO\", \"CB\" (exactamente as√≠, en may√∫sculas)\n   \n   b) **Fecha en formato correcto**:\n      - Formato requerido: \"DD-MMM\" (ej: \"10-ene\", \"25-mar\")\n      - Si el usuario dice \"10 de enero\", convierte a \"10-ene\"\n      - Si el usuario dice \"enero\", pregunta: \"¬øQu√© d√≠a de enero?\"\n      - Meses v√°lidos: ene, feb, mar, abr, may, jun, jul, ago, sep, oct, nov, dic\n   \n   c) **Monto como n√∫mero**:\n      - Si el usuario dice \"$50.000\", convierte a 50000 (sin s√≠mbolos, sin puntos, sin comas)\n      - Si el usuario dice \"cincuenta mil\", convierte a 50000\n   \n   d) **Tipo de movimiento**:\n      - Si dice \"gasto\", \"egreso\", \"pago\", \"compra\" ‚Üí tipo: \"EGRESO\"\n      - Si dice \"ingreso\", \"cobro\", \"venta\" ‚Üí tipo: \"INGRESO\"\n   \n   e) **Confirmaci√≥n del usuario**:\n      - SIEMPRE pregunta: \"¬øConfirmas que quieres [CREAR/ACTUALIZAR/MARCAR] este registro?\"\n      - Muestra un resumen claro de lo que vas a hacer\n      - Solo ejecuta si el usuario confirma expl√≠citamente (\"S√≠\", \"Confirmo\", \"Dale\", \"Ok\", etc.)\n      - Si dice \"No\" o duda, NO ejecutes la herramienta\n\n   üìã EJEMPLO DE LLAMADA CORRECTA:\n   ```\n   register({\n     sheet_name: \"CASAZ\",\n     accion: \"CREAR\",\n     datos: {\n       fecha: \"10-ene\",\n       descripcion: \"Arriendo\",\n       tipo: \"EGRESO\",\n       monto: 50000,\n       categoria: \"Arriendo\",\n       comentario: \"Pago mensual\"\n     }\n   })\n   ```\n\n5. **Formato de Respuestas**:\n   - Presenta los datos en tablas Markdown cuando sean m√∫ltiples registros\n   - Usa emojis para hacer las respuestas m√°s amigables: üí∞ (dinero), üìä (an√°lisis), ‚úÖ (√©xito), ‚ö†Ô∏è (alerta)\n   - Siempre incluye el TOTAL cuando muestres gastos/ingresos\n\n6. **Ejemplo de Interacci√≥n Ideal (B√∫squeda)**:\n   Usuario: \"Gastos de luz en enero\"\n   T√∫ piensas: ¬øFalta la empresa?\n   T√∫ respondes: \"¬øDe qu√© empresa quieres ver los gastos de luz? (CASAZ, ROBUSTA, ARPINO o CB)\"\n   \n   Usuario: \"CASAZ\"\n   T√∫ usas: search(sheet_name=\"CASAZ\", filter_desc=\"luz enero\")\n   T√∫ respondes con los datos formateados\n\n7. **Ejemplo de Interacci√≥n Ideal (Registro)**:\n   Usuario: \"Registra el arriendo de enero\"\n   T√∫: \"¬øDe qu√© empresa? (CASAZ, ROBUSTA, ARPINO o CB)\"\n   Usuario: \"CASAZ\"\n   T√∫: \"¬øCu√°l fue el monto y la fecha exacta?\"\n   Usuario: \"$500.000 el 5 de enero\"\n   T√∫: \"¬øConfirmas que quieres CREAR este registro?\n   üìã Detalles:\n   - Empresa: CASAZ\n   - Fecha: 05-ene\n   - Concepto: Arriendo\n   - Tipo: EGRESO\n   - Monto: $500.000\"\n   \n   Usuario: \"S√≠\"\n   T√∫ usas: register(sheet_name=\"CASAZ\", accion=\"CREAR\", datos={fecha: \"05-ene\", descripcion: \"Arriendo\", tipo: \"EGRESO\", monto: 500000, categoria: \"Arriendo\"})\n   T√∫ respondes: \"‚úÖ Registro creado exitosamente en CASAZ\"\n\nüí° IMPORTANTE:\n- Siempre s√© amable y profesional\n- Si no encuentras datos, sugiere alternativas (\"¬øQuisiste decir 'Electricidad'?\")\n- Si hay muchos resultados, pregunta si quiere un an√°lisis (suma total, promedio, etc.)\n- NUNCA modifiques datos sin confirmaci√≥n expl√≠cita del usuario\n- NUNCA llames a \"register\" sin tener sheet_name, accion y datos completos",
                    "maxIterations": 10
                }
            },
            "id": "29b8f667-a812-44da-b611-26f67bd01158",
            "name": "AI Agent",
            "type": "@n8n/n8n-nodes-langchain.agent",
            "position": [
                944,
                128
            ],
            "typeVersion": 1.6
        },
        {
            "parameters": {
                "sessionIdType": "customKey",
                "sessionKey": "={{ $('When chat message received').item.json.sessionId }}"
            },
            "id": "769735d5-9270-4a4f-bfc3-41ceeffdacb1",
            "name": "Window Buffer Memory",
            "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
            "position": [
                864,
                400
            ],
            "typeVersion": 1.3
        },
        {
            "parameters": {
                "options": {}
            },
            "id": "587a67c1-4176-4d71-9435-666d88cd42f7",
            "name": "When chat message received",
            "type": "@n8n/n8n-nodes-langchain.chatTrigger",
            "position": [
                720,
                128
            ],
            "webhookId": "abf9ab75-eaca-4b91-b3ba-c0f83d3daba4",
            "typeVersion": 1.1
        },
        {
            "parameters": {
                "name": "search",
                "description": "Busca registros de pagos en Google Sheets del holding Tu Gatita Loca.\n\nüìã PAR√ÅMETROS REQUERIDOS:\n- sheet_name: Nombre exacto de la empresa (CASAZ, ROBUSTA, ARPINO o CB)\n- filter_desc: (OPCIONAL) T√©rmino de b√∫squeda. Ejemplos:\n  ¬∑ \"Luz\" ‚Üí busca gastos de luz\n  ¬∑ \"Enero\" ‚Üí busca movimientos de enero\n  ¬∑ \"Sueldos\" ‚Üí busca pagos de sueldos\n  ¬∑ Dejar vac√≠o ‚Üí devuelve TODOS los registros de la empresa\n\n‚úÖ SALIDA:\nDevuelve un JSON con array de registros encontrados. Cada registro incluye:\n- FECHA, DESCRIPCION / DETALLE, INGRESO, EGRESO, SALDO, CATEGORIA, COMENTARIO\n\nüí° CONSEJO:\nSi el usuario pide \"todo\" o \"todos los gastos\", NO env√≠es filter_desc.",
                "workflowId": {
                    "__rl": true,
                    "value": "NHngBgZ3GCrfj0SN",
                    "mode": "list",
                    "cachedResultUrl": "/workflow/NHngBgZ3GCrfj0SN",
                    "cachedResultName": "HERRAMIENTAS GATITA"
                },
                "fields": {
                    "values": [
                        {
                            "name": "command",
                            "stringValue": "search"
                        }
                    ]
                },
                "specifyInputSchema": true,
                "schemaType": "manual",
                "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"sheet_name\": {\n      \"type\": \"string\",\n      \"enum\": [\"CASAZ\", \"ROBUSTA\", \"ARPINO\", \"CB\"],\n      \"description\": \"Nombre exacto de la empresa a consultar (OBLIGATORIO)\"\n    },\n    \"filter_desc\": {\n      \"type\": \"string\",\n      \"description\": \"T√©rmino de b√∫squeda (conceptos, meses, categor√≠as). Dejar vac√≠o para obtener todos los registros.\"\n    }\n  },\n  \"required\": [\"sheet_name\"]\n}"
            },
            "id": "9afab386-feb7-44aa-a600-1ee4fa6a7118",
            "name": "Search records",
            "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
            "position": [
                1008,
                400
            ],
            "typeVersion": 1.2
        },
        {
            "parameters": {
                "name": "analyze",
                "description": "Procesa y analiza datos de pagos usando Python (Code Interpreter de OpenAI).\n\nüìä USO:\n- C√°lculos matem√°ticos (promedios, sumas, tendencias)\n- Generaci√≥n de gr√°ficos (barras, l√≠neas, pie charts)\n- An√°lisis de patrones (gastos recurrentes, comparaciones mensuales)\n\nüìã PAR√ÅMETROS:\n- request: Descripci√≥n clara de lo que quieres hacer\n  Ejemplos: \"Calcular el total de egresos\", \"Generar gr√°fico de gastos por categor√≠a\", \"Comparar ingresos de enero vs febrero\"\n- data: Datos crudos en formato JSON string (usa JSON.stringify de los resultados de 'search')\n\n‚úÖ SALIDA:\n- Texto con el resultado del an√°lisis\n- (Opcional) Enlace a imagen de gr√°fico generado\n\n‚ö†Ô∏è IMPORTANTE:\n- Env√≠a los datos CRUDOS que obtuviste de 'search'\n- NO hagas c√°lculos por tu cuenta, deja que Python lo haga\n- Si hay muchos datos (>100 registros), pregunta primero al usuario qu√© an√°lisis espec√≠fico quiere",
                "workflowId": {
                    "__rl": true,
                    "value": "NHngBgZ3GCrfj0SN",
                    "mode": "list",
                    "cachedResultUrl": "/workflow/NHngBgZ3GCrfj0SN",
                    "cachedResultName": "HERRAMIENTAS GATITA"
                },
                "fields": {
                    "values": [
                        {
                            "name": "command",
                            "stringValue": "code"
                        }
                    ]
                },
                "specifyInputSchema": true,
                "schemaType": "manual",
                "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"request\": {\n      \"type\": \"string\",\n      \"description\": \"Descripci√≥n de la operaci√≥n a realizar (ej: 'Calcular promedio de egresos', 'Generar gr√°fico de barras por categor√≠a')\"\n    },\n    \"data\": {\n      \"type\": \"string\",\n      \"description\": \"Datos en formato JSON string (usa JSON.stringify del resultado de 'search')\"\n    }\n  },\n  \"required\": [\"request\", \"data\"]\n}"
            },
            "id": "342ef631-a6a3-4d07-a01e-38e2a22d764e",
            "name": "Analyze data with code",
            "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
            "position": [
                1136,
                400
            ],
            "typeVersion": 1.2
        },
        {
            "parameters": {
                "name": "register",
                "description": "Registra, actualiza o marca registros en Google Sheets del holding Tu Gatita Loca.\n\nüìã ACCIONES DISPONIBLES:\n\n1Ô∏è‚É£ CREAR - Registrar un nuevo pago/gasto:\n   - FOLIO: N√∫mero de folio\n   - RUT: RUT del proveedor (formato: 12345678-9)\n   - RAZON SOCIAL: Nombre del proveedor/cliente\n   - SALDO PENDIENTE: Monto sin s√≠mbolos (ej: 500000)\n   - COMENTARIO: (Opcional) Comentarios adicionales\n   - GLOSA: (Opcional) Categor√≠a o glosa\n\n2Ô∏è‚É£ ACTUALIZAR - Modificar campos de un registro existente:\n   - Requiere filtro.razon_social para buscar el registro\n   - Puede actualizar: COMENTARIO, GLOSA, SALDO PENDIENTE\n\n3Ô∏è‚É£ MARCAR_PAGADO - Agregar \"‚úÖ PROCESADO\" al comentario:\n   - Requiere filtro.razon_social para buscar el registro\n\n‚úÖ SALIDA:\nDevuelve confirmaci√≥n de la operaci√≥n realizada.",
                "workflowId": {
                    "__rl": true,
                    "value": "NHngBgZ3GCrfj0SN",
                    "mode": "list",
                    "cachedResultUrl": "/workflow/NHngBgZ3GCrfj0SN",
                    "cachedResultName": "HERRAMIENTAS GATITA"
                },
                "fields": {
                    "values": [
                        {
                            "name": "command",
                            "stringValue": "register"
                        }
                    ]
                },
                "specifyInputSchema": true,
                "schemaType": "manual",
                "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"sheet_name\": {\n      \"type\": \"string\",\n      \"enum\": [\"CASAZ\", \"ROBUSTA\", \"ARPINO\", \"CB\"],\n      \"description\": \"Nombre exacto de la empresa (OBLIGATORIO)\"\n    },\n    \"accion\": {\n      \"type\": \"string\",\n      \"enum\": [\"CREAR\", \"ACTUALIZAR\", \"MARCAR_PAGADO\"],\n      \"description\": \"Acci√≥n a realizar (OBLIGATORIO)\"\n    },\n    \"FOLIO\": {\n      \"type\": \"string\",\n      \"description\": \"N√∫mero de folio (solo para CREAR)\"\n    },\n    \"RUT\": {\n      \"type\": \"string\",\n      \"description\": \"RUT del proveedor/cliente formato 12345678-9 (solo para CREAR)\"\n    },\n    \"RAZON SOCIAL\": {\n      \"type\": \"string\",\n      \"description\": \"Nombre o raz√≥n social del proveedor/cliente (para CREAR o buscar en ACTUALIZAR/MARCAR)\"\n    },\n    \"SALDO PENDIENTE\": {\n      \"type\": \"number\",\n      \"description\": \"Monto del saldo pendiente sin s√≠mbolos (solo para CREAR)\"\n    },\n    \"COMENTARIO\": {\n      \"type\": \"string\",\n      \"description\": \"Comentarios adicionales (opcional)\"\n    },\n    \"GLOSA\": {\n      \"type\": \"string\",\n      \"description\": \"Glosa o categor√≠a (opcional)\"\n    }\n  },\n  \"required\": [\"sheet_name\", \"accion\"]\n}"
            },
            "id": "8c7e7c6b-1a5e-4e5e-9e5e-7c6b1a5e5e5e",
            "name": "Register/Update records",
            "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
            "position": [
                1008,
                640
            ],
            "typeVersion": 1.2
        }
    ],
    "connections": {
        "OpenAI Chat Model": {
            "ai_languageModel": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Window Buffer Memory": {
            "ai_memory": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_memory",
                        "index": 0
                    }
                ]
            ]
        },
        "When chat message received": {
            "main": [
                [
                    {
                        "node": "AI Agent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Search records": {
            "ai_tool": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_tool",
                        "index": 0
                    }
                ]
            ]
        },
        "Analyze data with code": {
            "ai_tool": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_tool",
                        "index": 0
                    }
                ]
            ]
        },
        "Register/Update records": {
            "ai_tool": [
                [
                    {
                        "node": "AI Agent",
                        "type": "ai_tool",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {
        "executionOrder": "v1"
    },
    "tags": []
}